<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cho ph√©p nh·∫≠n th√¥ng b√°o</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 2rem 1rem;
      background: #f8f9fa;
      color: #333;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .btn {
      font-size: 1.1rem;
      padding: 12px 20px;
      border-radius: 8px;
    }

    .alert {
      font-size: 0.95rem;
    }

    ul {
      padding-left: 1.2rem;
      text-align: left;
    }

    .hidden {
      display: none;
    }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FERX73KD2F"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-FERX73KD2F');
  </script>
</head>

<body>

  <div class="container">
    <div class="card p-4">
      <div>
        <h5><strong>üîê C·∫•p quy·ªÅn ƒë·ªÉ Tool AI ho·∫°t ƒë·ªông hi·ªáu qu·∫£ v√† ch√≠nh x√°c </strong></h5>
        <p class="mb-4">B·∫°n th·ª±c hi·ªán thi·∫øt l·∫≠p tool theo c√°c b∆∞·ªõc sau:</p>
        <p class="mb-4">B∆∞·ªõc 1: nh·∫•n v√†o n√∫t b√™n d∆∞·ªõi.</p>
        <p class="mb-4">B∆∞·ªõc 2: nh·∫•n cho ph√©p (Allow)</p>
        <button id="btn-allow" class="btn btn-primary btn-block">üéØ Cho ph√©p nh·∫≠n th√¥ng b√°o</button>
      </div>
    </div>

    <div id="denied-message" class="alert alert-danger mt-4 hidden text-center">
      <p><strong>‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi th√¥ng b√°o.</strong></p>
      <p>Vui l√≤ng b·∫≠t l·∫°i quy·ªÅn trong <strong>c√†i ƒë·∫∑t tr√¨nh duy·ªát</strong> ƒë·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng Tool AI.</p>
      <ul>
        <li><strong>Chrome:</strong> C√†i ƒë·∫∑t ‚Üí Quy·ªÅn ‚Üí Th√¥ng b√°o ‚Üí Cho ph√©p v·ªõi trang n√†y</li>
        <li><strong>Safari:</strong> Setting ‚Üí Websites ‚Üí Notifications</li>
      </ul>
    </div>

    <div id="error-message" class="alert alert-warning mt-4 hidden text-center"></div>
  </div>

  <script src="js/utils-url.js"></script>
  <script src="js/utils.js"></script>
  <script>
    const btnAllow = document.getElementById('btn-allow');
    const deniedMsg = document.getElementById('denied-message');
    const errorMsg = document.getElementById('error-message');

    btnAllow.addEventListener('click', async () => {
      btnAllow.disabled = true;
      btnAllow.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω...';

      deniedMsg.classList.add('hidden');
      errorMsg.classList.add('hidden');

      try {
        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
          console.log("‚úÖ Quy·ªÅn ƒë√£ ƒë∆∞·ª£c c·∫•p");
          await registerPush();
          window.location.href = 'dashboard.html?page=tool';
        } else if (permission === 'denied') {
          deniedMsg.classList.remove('hidden');
          btnAllow.disabled = false;
          btnAllow.innerHTML = 'üéØ Cho ph√©p th√¥ng b√°o';
        } else {
          throw new Error('Tr√¨nh duy·ªát kh√¥ng ph·∫£n h·ªìi y√™u c·∫ßu quy·ªÅn th√¥ng b√°o.');
        }
      } catch (err) {
        console.error('L·ªói xin quy·ªÅn:', err);
        errorMsg.textContent = '‚ö†Ô∏è C√≥ l·ªói x·∫£y ra khi ƒëƒÉng k√Ω th√¥ng b√°o. Vui l√≤ng th·ª≠ l·∫°i.';
        errorMsg.classList.remove('hidden');
        btnAllow.disabled = false;
        btnAllow.innerHTML = 'üéØ Th·ª≠ l·∫°i';
      }
    });

    async function registerPush() {
      if (!('serviceWorker' in navigator)) {
        throw new Error('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Service Worker.');
      }

      // 1Ô∏è‚É£ ƒêƒÉng k√Ω ho·∫∑c l·∫•y service worker hi·ªán c√≥
      const reg = await navigator.serviceWorker.register('/service-worker.js');
      console.log('Service Worker ƒëƒÉng k√Ω th√†nh c√¥ng:', reg);

      // 2Ô∏è‚É£ Ch·ªù service worker k√≠ch ho·∫°t ho√†n to√†n
      const sw = await navigator.serviceWorker.ready;

      // 3Ô∏è‚É£ Ki·ªÉm tra n·∫øu ƒë√£ c√≥ subscription c≈©
      let sub = await sw.pushManager.getSubscription();
      if (!sub) {
        console.log("Ch∆∞a c√≥ subscription, t·∫°o m·ªõi...");
        sub = await sw.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(
            'BBeZbEwXml_v93n0caqGDxOEdX8WMjFMc018zOtujFo-w6mTLDWDqXqGot4CoyFz0VJUKiYCA6TmDUq9Bk4964U'
          ),
        });
      } else {
        console.log("ƒê√£ c√≥ subscription c≈©, d√πng l·∫°i.");
      }

      // 4Ô∏è‚É£ G·ª≠i subscription l√™n server
      const token = localStorage.getItem('accessToken');
      if (!token) throw new Error('Kh√¥ng t√¨m th·∫•y token trong localStorage.');

      const headers = {
        'Content-Type': 'application/json',
        Authorization: 'Bearer ' + token,
        'x-device-id': getDeviceId(),
      };

      const res = await fetch(getUrl() + '/api/auth/save-web-subscription', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          platform: 'web',
          subscription: sub,
        }),
      });

      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ l∆∞u th√¥ng tin ƒëƒÉng k√Ω l√™n server.');

      console.log('‚úÖ ƒê√£ ƒëƒÉng k√Ω subscription th√†nh c√¥ng');
    }
    
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      return new Uint8Array([...rawData].map(c => c.charCodeAt(0)));
    }
  </script>
</body>

</html>