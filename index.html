<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ƒêƒÉng nh·∫≠p Tool AI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      color: #6c757d;
      font-size: 14px;
      margin: 1rem 0;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid #dee2e6;
    }

    .divider:not(:empty)::before {
      margin-right: .75em;
    }

    .divider:not(:empty)::after {
      margin-left: .75em;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tool AI">
  <link rel="apple-touch-icon" href="assets/icon-192.png">

  <script>
    function isIOSDevice() {
      //return /iPhone|iPad|iPod/i.test(navigator.userAgent);
      return true;
    }

    if (!isIOSDevice()) {
      window.location.href = "unsupported.html";
    }
  </script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABC123XYZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    // Kh·ªüi t·∫°o GA4
    gtag('config', 'G-ABC123XYZ', {
      send_page_view: true
    });
  </script>
</head>

<body class="d-flex justify-content-center align-items-center vh-100">

  <div id="login-box" class="text-center p-4 card shadow-sm" style="max-width: 400px; width: 100%;">
    <img src="/assets/ic_launcher_round.png" alt="Logo Tool AI" class="mb-4" style="width: 100px; height: 100px;">

    <h5 class="mb-3 font-weight-bold">ƒêƒÉng nh·∫≠p Tool AI</h5>

    <!-- Google login -->
    <p id="sutitleLogin">ƒêƒÉng nh·∫≠p nhanh (1 ch·∫°m) v·ªõi</p>
    <div id="g_id_onload" data-client_id="806969458384-k9jefp2tnts2q2rqgobn2f1bi24t6fh5.apps.googleusercontent.com"
      data-callback="handleLogin" data-auto_prompt="false"></div>
    <div class="g_id_signin mb-4" data-type="standard"></div>

    <div class="divider my-3"><span>ho·∫∑c</span></div>

    <!-- Email login form -->
    <form id="emailLoginForm" onsubmit="return handleEmailLogin(event)">
      <div class="form-group text-left">
        <label for="email">Email</label>
        <input type="email" id="email" class="form-control" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
      </div>
      <div class="form-group text-left">
        <label for="password">M·∫≠t kh·∫©u</label>
        <input type="password" id="password" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
      </div>
      <button type="submit" id="btnLogin" class="btn btn-primary btn-block mt-3">ƒêƒÉng nh·∫≠p</button>
    </form>

    <div id="loginStatus" class="mt-3 text-muted small"></div>

    <a href="forgot-step1.html" class="d-block mt-3 small">Qu√™n m·∫≠t kh·∫©u?</a>
    <a href="register-step1.html" class="d-block mt-3 small">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</a>
  </div>

  <!-- loading overlay -->
  <div id="loading-overlay" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.3);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  ">
    <div class="spinner-border text-light" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
  <script src="js/utils-url.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script>
    (async function autoLoginCheck() {
      const token = localStorage.getItem("accessToken");
      const email = localStorage.getItem("userEmail");

      if (!token || !email) return;
      showLoading();
      try {
        const res = await fetch(getUrl() + "/api/auth/check-token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token,
            "x-device-id": getDeviceId()
          }
        });

        const data = await res.json();
        if (data.valid) {
          console.log("‚úÖ Token h·ª£p l·ªá, t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p...");
          window.location.href = "dashboard.html?page=tool";
        } else {
          console.log("‚ùå Token kh√¥ng h·ª£p l·ªá:", data.message);
          localStorage.removeItem("accessToken");
        }
        hideLoading();
      } catch (err) {
        console.error("L·ªói ki·ªÉm tra token:", err);
        hideLoading();
      }
    })();
  </script>
  <script>
    function isIos() {
      //return /iphone|ipad|ipod/i.test(window.navigator.userAgent);
      return true;
    }

    function isInStandaloneMode() {
      return ('standalone' in window.navigator) && window.navigator.standalone;
    }

    function showAddToHomeScreenPrompt() {
      const guide = document.createElement('div');
      guide.id = 'ios-install-guide';
      guide.innerHTML = `
    <div class="guide-overlay">
      <div class="guide-box">
        <h3>Th√™m Tool AI ra M√†n h√¨nh ch√≠nh üì±</h3>
        <p>ƒê·ªÉ s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng (th√¥ng b√°o, t·ª± ƒë·ªông, v.v), b·∫°n c·∫ßn th√™m ·ª©ng d·ª•ng ra m√†n h√¨nh ch√≠nh.</p>
        <p>Nh·∫•n bi·ªÉu t∆∞·ª£ng <img src="/assets/share-icon.png" alt="Share icon" class="icon-share"> sau ƒë√≥ ch·ªçn <strong>Th√™m v√†o M√†n h√¨nh ch√≠nh</strong>.</p>
        <button id="closeGuide">ƒê√£ hi·ªÉu</button>
      </div>
    </div>
  `;
      document.body.appendChild(guide);

      document.getElementById('closeGuide').onclick = () => {
        guide.remove();
        localStorage.setItem('hideIosGuide', '1');
      };
    }

    // Ch·∫°y khi load trang
    window.addEventListener('load', () => {
      if (isIos() && !isInStandaloneMode() && !localStorage.getItem('hideIosGuide')) {
        showAddToHomeScreenPrompt();
      }

      const googleBtn = document.querySelector(".g_id_signin");
      const divider = document.querySelector(".divider");
      const sutitleLogin = document.getElementById("sutitleLogin");

      // N·∫øu kh√¥ng c√≥ Google Identity API ho·∫∑c n√∫t Google kh√¥ng t·ªìn t·∫°i
      if (typeof window.google === "undefined" || !window.google.accounts || !googleBtn) {
        if (divider) divider.style.display = "none";
        if (sutitleLogin) sutitleLogin.style.display = "none";
      }
    });
  </script>
</body>

</html>