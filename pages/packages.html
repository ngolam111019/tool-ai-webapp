<div class="card mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div class="font-weight-bold">üí∞ Xu:</div>
        <div id="xu">0</div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <div><strong id="package-name">G√≥i Premium</strong></div>
            <div class="text-muted small mt-2" id="package-expired">H·∫øt h·∫°n: 01/08/2025</div>
            <div class="text-muted small mt-2" id="package-turns">L∆∞·ª£t h√¥m nay: 5/100</div>
        </div>
    </div>
</div>

<div class="scroll-wrapper px-2">
    <div id="package-list" class="scroll-container d-flex flex-nowrap"></div>
</div>

<script>
    var _currentAccount = null; // Bi·∫øn to√†n c·ª•c l∆∞u th√¥ng tin t√†i kho·∫£n ƒë·ªÉ ki·ªÉm tra Xu

    loadPackages().then(data => {
        if (data) {
            renderPackages(data);
            _packageList = data;
        } else {
            document.getElementById("package-list").innerHTML = "L·ªói kh√¥ng load ƒë∆∞·ª£c d·ªØ li·ªáu";
        }
    });

    function renderPackages(packages) {
        const html = packages.map(pkg => {
            let name = pkg.name;
            if (pkg.is_best_saler == "1") name += " (‚≠êÔ∏è b√°n ch·∫°y)";
            if (pkg.is_gift == "1") name += " (üéÅ b√≠ k√≠p)";

            return `
                <div class="card shadow-sm" style="min-width: 250px; background-color: ${pkg.bg_color || '#343a40'};">
                    <div class="card-body">
                        <h5 class="card-title" style="color: ${pkg.color || '#fff'}">${name}</h5>
                        ${pkg.price_2 > 0 ? `
                            <p class="card-text text-danger small" id="countdown-${pkg.id}"></p>
                            <p class="card-text h6" style="text-decoration: line-through" id="price2-${pkg.id}">${formatThousandsVNXu(pkg.price_2)}</p>` : ''}
                        <p class="card-text text-danger h4">${formatThousandsVNXu(pkg.price)}</p>
                        <p class="card-text h6">${getExpiredInfo(pkg)}</p>
                        <p class="card-text">${getDescription(pkg)}</p>
                        <div class="text-center">
                            <button class="btn btn-sm text-light" style="background-color: ${pkg.color || '#fff'}" 
                                onclick="xacNhanThanhToan('${pkg.id}')">N√¢ng c·∫•p ngay</button>
                        </div>
                    </div>
                </div>`;
        }).join("");

        document.getElementById("package-list").innerHTML = html;

        gtag('event', 'view_packages', {
            page_title: 'Trang n√¢ng c·∫•p g√≥i',
            user_email: localStorage.getItem("userEmail")
        });
    }

    /**
     * Logic quy·∫øt ƒë·ªãnh n√¢ng c·∫•p (Decision Engine)
     * ƒê∆∞·ª£c port t·ª´ logic PackageListActivity.java
     */
    function xacNhanThanhToan(goiId) {
        if (!_currentAccount || !_packageList) {
            showAlert("ƒêang t·∫£i d·ªØ li·ªáu t√†i kho·∫£n, vui l√≤ng th·ª≠ l·∫°i sau.");
            return;
        }

        const goi = _packageList.find(p => p.id == goiId);
        if (!goi) return;

        const xuHienTai = _currentAccount.xu || 0;
        const giaGoi = goi.price;

        if (xuHienTai >= giaGoi) {
            // K·ªäCH B·∫¢N 1: ƒê·ªß Xu -> N√¢ng c·∫•p tr·ª±c ti·∫øp (DIRECT_UPGRADE)
            if (confirm(`B·∫°n ƒëang c√≥ ${formatThousandsVNXu(xuHienTai)}. X√°c nh·∫≠n d√πng ${formatThousandsVNXu(giaGoi)} ƒë·ªÉ n√¢ng c·∫•p g√≥i ${goi.name}?`)) {
                performUpgrade(goi.id); // G·ªçi h√†m n√†y trong main.js
            }
        } else {
            // K·ªäCH B·∫¢N 2: Thi·∫øu Xu
            const soTienThieu = giaGoi - xuHienTai;

            if (soTienThieu > 2000000) {
                // Thi·∫øu > 2M: Ch·ªâ n·∫°p th√™m (ONLY_RECHARGE)
                if (confirm(`S·ªë d∆∞ Xu kh√¥ng ƒë·ªß. B·∫°n c·∫ßn n·∫°p th√™m √≠t nh·∫•t ${formatThousandsVNXu(soTienThieu)}. ƒêi t·ªõi trang n·∫°p Xu?`)) {
                    loadPage('payment', { id: goiId });
                }
            } else {
                // Thi·∫øu <= 2M: N·∫°p s·ªë thi·∫øu v√† n√¢ng c·∫•p lu√¥n (RECHARGE_AND_UPGRADE)
                if (confirm(`B·∫°n c√≤n thi·∫øu ${formatThousandsVNXu(soTienThieu)}. B·∫°n c√≥ mu·ªën n·∫°p th√™m v√† n√¢ng c·∫•p g√≥i ${goi.name} ngay?`)) {
                    // Truy·ªÅn tham s·ªë amount sang payment.html ƒë·ªÉ t·∫°o QR ch√≠nh x√°c s·ªë ti·ªÅn thi·∫øu
                    loadPage('payment', { id: goiId, amount: soTienThieu });
                }
            }
        }
    }

    // Load th√¥ng tin t√†i kho·∫£n v√† l∆∞u v√†o bi·∫øn to√†n c·ª•c
    loadAccountInfo().then(data => {
        if (data) {
            _currentAccount = data; // L∆∞u l·∫°i ƒë·ªÉ xacNhanThanhToan s·ª≠ d·ª•ng
            renderAccountInfo(data);
        } else {
            const accInfo = document.getElementById("account-info");
            if (accInfo) accInfo.innerHTML = "<p class='text-danger'>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin t√†i kho·∫£n.</p>";
        }
    });

    // --- C√°c h√†m ph·ª• tr·ª£ (gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n) ---
    function getDescription(pkg) {
        let desc = pkg.description;
        if (desc.includes("{{gateways_str}}")) {
            const gatewaysStr = pkg.gateways.length > 1 ? "c√°c c·ªïng game " + pkg.gateways.join(", ") : "c·ªïng game " + pkg.gateways[0];
            desc = desc.replace("{{gateways_str}}", gatewaysStr);
        }
        if (desc.includes("{{duration_days_str}}")) {
            const durStr = pkg.duration_days > 1 ? pkg.duration_days + " ng√†y" : "24 gi·ªù";
            desc = desc.replace("{{duration_days_str}}", durStr);
        }
        if (desc.includes("{{max_turns_per_day_str}}")) {
            const maxTurnsStr = pkg.max_turns_per_day > 0 ? pkg.max_turns_per_day + " v√°n/ng√†y" : "kh√¥ng gi·ªõi h·∫°n";
            desc = desc.replace("{{max_turns_per_day_str}}", maxTurnsStr);
        }
        return desc;
    }

    function getExpiredInfo(pkg) {
        return "S·ª≠ d·ª•ng " + pkg.duration_days + " ng√†y - " + pkg.max_turns_per_day + " l∆∞·ª£t/ng√†y";
    }

    function initCountdownForPackages(packages) {
        packages.forEach(pkg => {
            const countdownKey = "countdown_pkg_" + pkg.id;
            let expiredAt = localStorage.getItem(countdownKey);
            if (!expiredAt) {
                expiredAt = Date.now() + 24 * 60 * 60 * 1000;
                localStorage.setItem(countdownKey, expiredAt);
            } else {
                expiredAt = parseInt(expiredAt);
            }
            startCountdown(pkg, expiredAt);
        });
    }

    function startCountdown(pkg, expiredAt) {
        const el = document.getElementById("countdown-" + pkg.id);
        const elPrice2 = document.getElementById("price2-" + pkg.id);
        if (!el) return;
        
        const price = parseInt(pkg.price);
        const price2 = parseInt(pkg.price_2 || 0);
        if (price2 > price) {
            const percent = (price2 > 0 && price < price2) ? Math.round((1 - price / price2) * 100) : 0;
            setInterval(() => {
                const now = Date.now();
                let diff = expiredAt - now;
                if (diff <= 0) {
                    expiredAt = Date.now() + 24 * 60 * 60 * 1000;
                    localStorage.setItem("countdown_pkg_" + pkg.id, expiredAt);
                    diff = expiredAt - now;
                }
                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                el.innerHTML = `‚è≥ ∆Øu ƒë√£i gi·∫£m ${percent}% ‚Äì c√≤n: ${h}:${m}:${s}`;
            }, 1000);
        }
        else if (price2 <= 10) {
            if (localStorage.getItem("nangCapDungThu") == "true") {
                el.innerHTML = `‚è≥ ƒê√£ b√°n h·∫øt 1000/1000 su·∫•t`;
            }
            else {
                el.innerHTML = `‚è≥ Ch·ªâ c√≤n ${price2} su·∫•t (ƒê√£ c√≥ ${1000 - price2} ng∆∞·ªùi ƒëƒÉng k√Ω) trong 30 ng√†y qua`;
            }
            if (elPrice2) elPrice2.innerHTML = ''; 
        }
        else {
            if (elPrice2) elPrice2.innerHTML = ''; 
        }
        /* } */
    }

    var _oldRenderPackages = renderPackages;
    renderPackages = function (data) {
        _oldRenderPackages(data);
        setTimeout(() => initCountdownForPackages(data), 200);
    };
</script>