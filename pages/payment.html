<div class="container py-4">
    <!-- Ph·∫ßn 1: Th√¥ng tin g√≥i -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">G√≥i b·∫°n ch·ªçn</h5>
            <p><strong id="package-name">---</strong></p>
            <p>Gi√°: <span id="package-price">---</span></p>
        </div>
    </div>

    <!-- Ph·∫ßn 2: M√£ QR v√† th√¥ng tin chuy·ªÉn kho·∫£n -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Qu√©t m√£ QR thanh to√°n</h5>
            <div class="text-center mb-3">
                <img id="qr-image" src="/assets/qr.png" alt="QR Code" style="max-width: 200px;">
            </div>
            <p class="text-center">--- ho·∫∑c chuy·ªÉn kho·∫£n ---</p>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Ng√¢n h√†ng:
                    <span>
                        <span id="bank-name">---</span>
                        <i class="fas fa-copy ml-2" onclick="copyText('bank-name')"></i>
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    S·ªë t√†i kho·∫£n:
                    <span>
                        <span id="bank-account">---</span>
                        <i class="fas fa-copy ml-2" onclick="copyText('bank-account')"></i>
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    N·ªôi dung:
                    <span>
                        <span id="transfer-content">---</span>
                        <i class="fas fa-copy ml-2" onclick="copyText('transfer-content')"></i>
                    </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    S·ªë ti·ªÅn:
                    <span>
                        <span id="amount">---</span> ƒë
                        <i class="fas fa-copy ml-2" onclick="copyText('amount')"></i>
                    </span>
                </li>
            </ul>
        </div>
    </div>
    <div class="text-center mt-3 text-danger font-weight-bold">
        Th·ªùi gian c√≤n l·∫°i: <span id="countdown">05:00</span>

        <!-- Ph·∫ßn 3: L∆∞u √Ω v√† n√∫t x√°c nh·∫≠n -->
        <div class="alert alert-warning text-center mt-3">
            Vui l√≤ng chuy·ªÉn kho·∫£n ƒë√∫ng n·ªôi dung v√† ch·ªù duy·ªát t·ª± ƒë·ªông trong v√†i ph√∫t.<br>
            N·∫øu ƒë√£ chuy·ªÉn, h√£y nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ x√°c nh·∫≠n.
        </div>

        <div class="text-center">
            <button class="btn btn-success btn-block" onclick="confirmPayment()">
                T√¥i ƒë√£ chuy·ªÉn kho·∫£n r·ªìi
            </button>
        </div>
    </div>
</div>
<!-- KH√îNG thay ƒë·ªïi giao di·ªán HTML b·∫°n ƒë√£ g·ª≠i -->

<script>
    var queryParams = new URLSearchParams(window.location.search);
    var packageId = parseInt(queryParams.get('id'));
    var socket;
    var socketTimeout;
    var isPaymentConfirmed = false;
    var countdownSeconds = 300; // 5 ph√∫t
    var countdownInterval = null;

    async function copyText(id) {
        const text = document.getElementById(id).innerText;
        await navigator.clipboard.writeText(text);
        showAlert('ƒê√£ sao ch√©p: ' + text);
    }

    async function getPackageById(id) {
        let cached = JSON.parse(localStorage.getItem("cachedPackages") || "[]");
        if (!Array.isArray(cached) || cached.length === 0) {
            await loadPackages(true);
            cached = JSON.parse(localStorage.getItem("cachedPackages") || "[]");
        }
        return cached.find(p => p.id == id);
    }

    async function confirmPayment() {
        isPaymentConfirmed = true;
        if (socket) {
            socket.disconnect();
            clearTimeout(socketTimeout);
        }
        showAlert("Vui l√≤ng ch·ªù x√°c nh·∫≠n giao d·ªãch trong v√†i ph√∫t.");
        loadPage('history');
    }

    function startCountdown() {
        updateCountdownDisplay();

        countdownInterval = setInterval(() => {
            countdownSeconds--;
            updateCountdownDisplay();

            if (countdownSeconds <= 0) {
                clearInterval(countdownInterval);
                $('#countdown').text("H·∫øt th·ªùi gian");

                if (socket && socket.connected) {
                    socket.disconnect();
                    console.log("‚è±Ô∏è Socket ƒë√£ ng·∫Øt sau 5 ph√∫t.");
                }
            }
        }, 1000);
    }

    function updateCountdownDisplay() {
        const min = String(Math.floor(countdownSeconds / 60)).padStart(2, '0');
        const sec = String(countdownSeconds % 60).padStart(2, '0');
        $('#countdown').text(`${min}:${sec}`);
    }

    function startPaymentSocket(txid) {
        if (socket) socket.disconnect();

        socket = io(getUrl());

        socket.emit("join_payment_room", txid);

        socket.on("payment_result", (data) => {
            if (data.is_success === true) {
                isPaymentConfirmed = true;
                if (socket) socket.disconnect();
                clearTimeout(socketTimeout);
                clearInterval(countdownInterval);
                showAlert("üí∞ Giao d·ªãch th√†nh c√¥ng! Chuy·ªÉn sang l·ªãch s·ª≠ ƒë·ªÉ xem tr·∫°ng th√°i.");
                loadPage("history");
            } else {
                showAlert(data.message || "Giao d·ªãch th·∫•t b·∫°i.");
                loadPage("history");
            }
        });

        // ‚è±Ô∏è ƒê·∫∑t timeout ng·∫Øt socket sau 5 ph√∫t
        socketTimeout = setTimeout(() => {
            if (!isPaymentConfirmed && socket) {
                socket.disconnect();
                console.log("üõë Socket t·ª± ƒë·ªông ng·∫Øt sau 5 ph√∫t.");
            }
        }, 5 * 60 * 1000);

        startCountdown();
    }

    // Load d·ªØ li·ªáu khi v√†o trang
    (async function () {
        try {
            if (!packageId) return showAlert("Thi·∫øu th√¥ng tin g√≥i.");

            const pkg = await getPackageById(packageId);
            if (!pkg) return showAlert("Kh√¥ng t√¨m th·∫•y g√≥i!");

            document.getElementById("package-name").innerText = pkg.name;
            document.getElementById("package-price").innerText = formatThousandsVNXu(pkg.price);

            showLoading();
            const payment = await fetchPaymentInfo(packageId, pkg.price);

            document.getElementById("qr-image").src = payment.qr_url;
            document.getElementById("bank-name").innerText = payment.bank;
            document.getElementById("bank-account").innerText = payment.account_number;
            document.getElementById("transfer-content").innerText = payment.content;
            document.getElementById("amount").innerText = formatThousandsVN(pkg.price);

            startPaymentSocket(payment.tranid);
        } catch (err) {
            showAlert("C√≥ l·ªói x·∫£y ra: " + err.message);
        } finally {
            hideLoading();
        }
    })();

    // C·∫£nh b√°o khi r·ªùi trang n·∫øu ch∆∞a x√°c nh·∫≠n thanh to√°n
    window.addEventListener('beforeunload', function (e) {
        if (!isPaymentConfirmed) {
            const confirmationMessage = '‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi khi ch∆∞a ho√†n t·∫•t thanh to√°n?';
            (e || window.event).returnValue = confirmationMessage;
            return confirmationMessage;
        }
    });
</script>