<div class="container py-3">
  <div id="transaction-list"></div>
</div>

<script>
// Icon theo tr·∫°ng th√°i
function getStatusIcon(status) {
  switch (status) {
    case 'success': return '<i class="fas fa-check-circle text-success"></i>';
    case 'pending': return '<i class="fas fa-hourglass-half text-warning"></i>';
    case 'failed':  return '<i class="fas fa-times-circle text-danger"></i>';
    default:        return '<i class="fas fa-question-circle text-secondary"></i>';
  }
}

function getStatusText(status) {
  switch (status) {
    case 'success': return 'Th√†nh c√¥ng';
    case 'pending': return 'ƒêang x·ª≠ l√Ω';
    case 'failed':  return 'Th·∫•t b·∫°i';
    default:        return '';
  }
}

function getColorStatus(status) {
  switch (status) {
    case 'success': return 'text-success';
    case 'pending': return 'text-muted';
    case 'failed':  return 'text-danger';
    default:        return 'text-muted';
  }
}


function getTypeText(status) {
  switch (status) {
    case 'payment': return 'N·∫°p QR';
    case 'purchase': return 'üì¶ N√¢ng c·∫•p';
    case 'bonus':  return 'üéÅ T·∫∑ng th√™m';
    default:        return '';
  }
}

function renderTransaction(tx) {
  const sign = tx.amount > 0 ? '+' : '-';
  const amount = Math.abs(tx.amount);
  return `
    <div class="card mb-2" onclick="showTransactionDetail(${tx.id})" style="cursor: pointer;">
      <div class="card-body d-flex align-items-center">
        <div class="mr-3">${getStatusIcon(tx.status)}</div>
        <div class="flex-grow-1">
          <div><strong>${getTypeText(tx.type)}</strong></div>
          <div class="text-muted small">${formatDateTimeVN(tx.created_at)}</div>
          <div class="small">Tr·∫°ng th√°i: <span class="text-capitalize">${getStatusText(tx.status)}</span></div>
        </div>
        <div class="ml-3 ${getColorStatus(tx.status)} font-weight-bold">
          ${sign}${formatThousandsVN(amount)} xu
        </div>
      </div>
    </div>
  `;
}
var transactionCache = []; // to√†n c·ª•c

async function loadTransactionHistory() {
  try {
    showLoading();
    const token = localStorage.getItem("accessToken");
    const res = await fetch(getUrl() + "/api/balance/logs", {
      headers: {
        Authorization: "Bearer " + token,
        "x-device-id": getDeviceId()
      }
    });

    transactionCache = await res.json(); // l∆∞u cache

    // ‚û§ Ki·ªÉm tra d·ªØ li·ªáu r·ªóng ho·∫∑c kh√¥ng ph·∫£i array
    if (!Array.isArray(transactionCache) || transactionCache.length === 0) {
      document.getElementById("transaction-list").innerHTML = `
        <div class="text-center text-muted py-4">
          Kh√¥ng c√≥ d·ªØ li·ªáu giao d·ªãch
        </div>`;
      return;
    }

    const html = transactionCache.map(renderTransaction).join('');
    document.getElementById("transaction-list").innerHTML = html;

  } catch (err) {
    console.error("[loadTransactionHistory] L·ªói:", err);

    // ‚û§ Tr∆∞·ªùng h·ª£p l·ªói API c≈©ng hi·ªÉn th·ªã "Kh√¥ng c√≥ d·ªØ li·ªáu"
    document.getElementById("transaction-list").innerHTML = `
      <div class="text-center text-muted py-4">
        Kh√¥ng c√≥ d·ªØ li·ªáu giao d·ªãch
      </div>`;
  }
  finally {
    hideLoading();
  }
}
function showTransactionDetail(id) {
  const tx = transactionCache.find(t => t.id == id);
  if (!tx) return showAlert("Kh√¥ng t√¨m th·∫•y giao d·ªãch!");

  const html = `
    <div class="card mt-3">
      <div class="card-body">
        <h5 class="card-title">Chi ti·∫øt giao d·ªãch</h5>
        <p><strong>TXID:</strong> ${tx.id}</p>
        <p><strong>Lo·∫°i giao d·ªãch:</strong> ${getTypeText(tx.type)}</p>
        <p><strong>Th·ªùi gian:</strong> ${formatDateTimeVN(tx.created_at)}</p>
        <p><strong>Tr·∫°ng th√°i:</strong> <span class="text-capitalize">${getStatusText(tx.status)}</span></p>
        <div class="mt-3 text-center">
          <button class="btn btn-outline-secondary btn-sm" onclick="hideTransactionDetail()">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  `;

  const detailEl = document.createElement("div");
  detailEl.id = "transaction-detail-popup";
  detailEl.style.position = "fixed";
  detailEl.style.top = "0";
  detailEl.style.left = "0";
  detailEl.style.width = "100%";
  detailEl.style.height = "100%";
  detailEl.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
  detailEl.style.zIndex = "9999";
  detailEl.innerHTML = `<div class="container mt-5">${html}</div>`;

  document.body.appendChild(detailEl);
}
function hideTransactionDetail() {
  const popup = document.getElementById("transaction-detail-popup");
  if (popup) popup.remove();
}
loadTransactionHistory();
</script>